#!/usr/bin/env bash

if (return 0 2>/dev/null); then
  >&2 echo -e "\e[31mThis script should not be sourced.\e[0m"
  return 1
fi

set -euo pipefail

run_checks() {
  if [ "$EUID" != "0" ]; then
    >&2 echo -e "\e[31mPlease run this script as root.\e[0m"
    exit 1
  fi
  if [ "$(grep ^ID= /etc/os-release | cut -d'=' -f2)" != nixos ]; then
    >&2 echo -e "\e[31mOnly run this command on NixOS.\e[0m"
    exit 1
  fi
  if ! [ -v SUDO_USER ]; then
    >&2 echo -e "\e[31mThis command has to be run with sudo so we can identity the user.\e[0m"
    exit 1
  fi
}

get_generic_profile() {
  local product_name
  if [ -f /sys/devices/virtual/dmi/id/product_name ]; then
    local product_name
    product_name=$(cat /sys/devices/virtual/dmi/id/product_name)
    if [ "$product_name" == "VirtualBox" ]; then
      local is_virtualbox=true
    else
      local is_virtualbox=false
    fi
  else
    local is_virtualbox=false
  fi
  # available profiles: nixos, nixos_virtualbox
  local profile=${1:-nixos}
  if $is_virtualbox; then
    profile+=_virtualbox
  fi
  host_platform="$(uname -m)"
  profile+=_$host_platform
  echo $profile
}

get_config_dir() {
  dry_run=${1:-false}
  local user_env
  if $dry_run && [ "$EUID" != "0" ]; then
    user_env=$(env)
  else
    user_env=$(su - "$SUDO_USER" -c env)
  fi
  local user_config_home
  user_config_home="$(echo "$user_env" | awk -F= '$1=="XDG_CONFIG_HOME"{print substr($0, index($0,$2))}')"
  if [ -z "$user_config_home" ]; then
    user_config_home="/home/$SUDO_USER/.config"
  fi
  local nixos_config_dir
  nixos_config_dir="$user_config_home/nixos"
  echo "$nixos_config_dir"
}

get_overrides() {
  local overrides=''
  local serverbase_flake_input
  serverbase_flake_input="$(basename "$(nix flake metadata "$(pwd)" --json | jq -r '.locks.nodes.serverbase.original.path // ""')")"
  if ! [ -z "$serverbase_flake_input" ]; then
    overrides="--override-input serverbase path:$nixos_config_dir/$serverbase_flake_input"
    if $VERBOSE; then
      echo "serverbase flake input: $serverbase_flake_input" >&2
    fi
  else
    echo "No serverbase flake input" >&2
  fi
  echo "$overrides"
}

_nr() {
  local get_profile=false
  export VERBOSE=false
  local switch=false
  local dry_run=false
  local forward_args=()
  local profile=''
  while [[ $# -gt 0 ]]; do
    case "$1" in
    --verbose)
      VERBOSE=true
      shift
      ;;
    --dry-run)
      dry_run=true
      shift
      ;;
    --get-profile)
      get_profile=true
      shift
      ;;
    switch)
      switch=true
      shift
      ;;
    *)
      forward_args+=("$1")
      shift
      ;;
    esac
  done
  set -- "${forward_args[@]}" # reset arguments

  if $dry_run; then
    if ! [ -v SUDO_USER ]; then
      SUDO_USER="$(whoami)"
      export SUDO_USER
    fi
  else
    run_checks
  fi

  # getting config dir
  local nixos_config_dir
  nixos_config_dir="$(get_config_dir $dry_run)"

  # getting profile
  local overrides
  overrides="$(get_overrides)"
  local profile
  # shellcheck disable=SC2086
  machine_name="$(nix run ".#list_machines" $overrides | grep "$(hostname)" || true)"
  profile=$(get_generic_profile "$machine_name")
  if [ -z "$machine_name" ]; then
    if ! $get_profile; then
      echo -e "\e[33mThis host does not have a specific profile, so it will run using the generic profile rules. Selected profile: \e[34m$profile\e[33m.\e[0m"
    fi
  fi

  if $get_profile; then
    echo -e "Profile: \e[34m$profile\e[33m.\e[0m"
    return
  fi
  if $switch; then
    local other_args=()
    if ! [ -z "$overrides" ]; then
      # shellcheck disable=SC2206
      other_args+=($overrides)
    fi
    if $VERBOSE; then
      other_args+=(--print-build-logs)
      echo -e "\e[32mRunning:\e[0m \e[34mnixos-rebuild switch $* --flake $nixos_config_dir?submodules=1#${profile} ${other_args[*]}" >&2
    fi
    if $dry_run; then
      echo -e "\e[32mWould run:\e[34m nixos-rebuild switch $* --flake $nixos_config_dir?submodules=1#${profile} ${other_args[*]}\e[0m"
    else
      nixos-rebuild switch "$@" --flake "$nixos_config_dir?submodules=1#${profile}" "${other_args[@]}"
    fi
  else
    if $VERBOSE; then
      echo -e "\e[32mRunning:\e[0m \e[34mnixos-rebuild $*" >&2
    fi
    if $dry_run; then
      echo -e "\e[32mWould run:\e[34m nixos-rebuild $*\e[0m"
    else
      nixos-rebuild "$@"
    fi
  fi
}

_nr "$@"
